name: Deploy Backend (Sequential Versioning)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # Sequential versioning
      - name: Set Sequential Version
        run: |
          if [ ! -f .version ]; then echo 0 > .version; fi
          VERSION=$(cat .version)
          VERSION=$((VERSION + 1))
          echo $VERSION > .version
          echo "IMAGE_TAG=v$VERSION" >> $GITHUB_ENV
          git config --global user.email "github@actions.com"
          git config --global user.name "GitHub Actions"
          git add .version
          git commit -m "Increment version to v$VERSION" || true
          git push || true

      - name: Build Docker Image
        run: docker build -t carbagar:${{ env.IMAGE_TAG }} .

      - name: Save Docker Image as TAR
        run: docker save -o carbagar_${{ env.IMAGE_TAG }}.tar carbagar:${{ env.IMAGE_TAG }}

      - name: Install SSH & Rsync
        run: sudo apt-get install -y openssh-client rsync

      - name: Add SSH Key
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: |
            ${{ secrets.VPS_KEY }}

      - name: Add VPS to known_hosts
        run: ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Upload TAR to VPS
        run: |
          rsync -avz carbagar_${{ env.IMAGE_TAG }}.tar \
          ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/root/devops/

      - name: Deploy on VPS
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "
            cd /root/devops &&
            echo 'ğŸ“¦ Load new image...' &&
            docker load -i carbagar_${{ env.IMAGE_TAG }}.tar &&

            echo 'ğŸš€ Deploying carbagar:${{ env.IMAGE_TAG }}' &&
            sed -i \"s|image: carbagar:.*|image: carbagar:${{ env.IMAGE_TAG }}|\" docker-compose.yml &&

            docker-compose up -d --build &&

            echo 'ğŸ” Checking health...' &&
            sleep 10 &&

            if docker ps --filter 'health=healthy' | grep -q carbagar; then
              echo 'ğŸ‰ API is Healthy!' &&
              echo 'ğŸ§¹ Cleaning old images & tar files...' &&
              docker image prune -f &&
              find /root/devops -name 'carbagar_v*.tar' -mtime +2 -delete
            else
              echo 'âŒ New version unhealthy! Rolling backâ€¦' &&
              git checkout HEAD~1 docker-compose.yml &&
              docker-compose up -d
            fi
          "
